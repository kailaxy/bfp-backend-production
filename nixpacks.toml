[phases.setup]
nixPkgs = ["nodejs_20", "python311", "python311Packages.pip", "python311Packages.virtualenv"]

[phases.install]
cmds = ["npm ci"]

[phases.postInstall]
cmds = [
  # Remove any existing venv and Python artifacts
  "rm -rf /opt/venv || true",
  "find /app -type d \\( -name 'numpy' -o -name 'pandas' -o -name 'scipy' -o -name 'statsmodels' -o -name '__pycache__' \\) -exec rm -rf {} + || true",
  "find /app -type f \\( -name '*.pyc' -o -name '*.pyo' \\) -delete || true",
  
  # Create fresh venv
  "python3 -m venv --clear /opt/venv",
  
  # Upgrade pip and install packages
  "/opt/venv/bin/pip install --upgrade pip setuptools wheel",
  "/opt/venv/bin/pip install --no-cache-dir --no-build-isolation numpy==1.26.4",
  "/opt/venv/bin/pip install --no-cache-dir pandas==2.2.0 scipy==1.12.0",
  "/opt/venv/bin/pip install --no-cache-dir statsmodels==0.14.1 scikit-learn",
  
  # Verify installation
  "/opt/venv/bin/python3 -c 'import numpy; print(f\"numpy {numpy.__version__} installed at {numpy.__file__}\")'",
  "/opt/venv/bin/python3 -c 'import pandas; print(f\"pandas {pandas.__version__} installed\")'",
  
  # Final cleanup of any Python source in /app
  "cd /app && find . -maxdepth 2 -type d \\( -name 'numpy' -o -name 'pandas' \\) ! -path './forecasting/*' -exec rm -rf {} + || true"
]

[start]
cmd = "bash start.sh"
