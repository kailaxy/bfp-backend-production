# Railway build configuration - includes system libraries for Python C-extensions and Canvas
[phases.setup]
nixPkgs = ["nodejs_20", "python311", "python311Packages.pip", "python311Packages.virtualenv", "zlib", "stdenv.cc.cc.lib", "libuuid", "cairo", "pango", "giflib", "libjpeg", "pixman", "freetype", "fontconfig"]
nixLibs = ["zlib", "stdenv.cc.cc.lib", "libuuid", "cairo", "pango", "giflib", "libjpeg", "pixman", "freetype", "fontconfig"]

[phases.install]
cmds = ["npm ci --prefer-offline --no-audit"]

[phases.build]
cmds = ["echo 'Skipping npm install in build phase'"]

[phases.postInstall]
cmds = [
  # Remove any existing venv and Python artifacts
  "rm -rf /opt/venv || true",
  "find /app -type d \\( -name 'numpy' -o -name 'pandas' -o -name 'scipy' -o -name 'statsmodels' -o -name '__pycache__' \\) -exec rm -rf {} + 2>/dev/null || true",
  "find /app -type f \\( -name '*.pyc' -o -name '*.pyo' \\) -delete 2>/dev/null || true",
  
  # Create fresh venv with system site packages
  "python3 -m venv --clear --system-site-packages /opt/venv",
  
  # Install packages in one command to reduce layers
  "/opt/venv/bin/pip install --upgrade pip setuptools wheel && /opt/venv/bin/pip install --no-cache-dir --no-build-isolation numpy==1.26.4 pandas==2.2.0 scipy==1.12.0 statsmodels==0.14.1",
  
  # Quick verification
  "/opt/venv/bin/python3 -c 'import numpy, pandas; print(f\"Packages ready: numpy {numpy.__version__}, pandas {pandas.__version__}\")'",
  
  # Final cleanup
  "find /app -maxdepth 2 -type d \\( -name 'numpy' -o -name 'pandas' \\) ! -path './forecasting/*' -exec rm -rf {} + 2>/dev/null || true"
]

[start]
cmd = "bash start.sh"
